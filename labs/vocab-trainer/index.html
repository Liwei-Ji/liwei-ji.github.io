<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcard Game</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --primary: #2b7fff;
      --ok: #10b981;
      --bad: #ef4444;
      --card: #f5f7fb;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --btn-bg: #f3f4f6;
    }
    [data-theme="dark"]{
      --bg: #0b0e11;
      --fg: #f5f7fb;
      --muted: #98a2b3;
      --primary: #76a8ff;
      --ok: #34d399;
      --bad: #f87171;
      --card: #151a21;
      --border: #1f2937;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --btn-bg: #1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px;
    }
    h1 { font-size: 18px; margin: 0; }
    .spacer { flex: 1; }
    .theme-toggle, .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--btn-bg); color: var(--fg);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
      font-size: 14px; transition: transform .06s ease, background .2s ease;
    }
    .theme-toggle:active, .btn:active { transform: scale(.98); }
    .container { max-width: 980px; margin: 0 auto; padding: 18px 16px 28px; }
    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px; margin-bottom: 14px;
    }
    .tab-btn {
      padding: 10px 10px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--card); color: var(--fg); cursor: pointer; font-weight: 600;
    }
    .tab-btn.active { outline: 2px solid var(--primary); }
    .panel { display: none; }
    .panel.active { display: block; }

    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .stack { display: grid; gap: 10px; }
    .select, input[type="text"]{
      background: var(--bg); color: var(--fg); border: 1px solid var(--border);
      padding: 8px 10px; border-radius: 10px; font-size: 14px;
    }
    .hint { color: var(--muted); font-size: 12px; }

    /* å¡ç‰‡ */
    .flashcard {
      background: var(--card); border: 1px solid var(--border); border-radius: 18px;
      min-height: 240px; padding: 26px; display: grid; place-items: center; text-align: center;
      box-shadow: var(--shadow);
    }
    .big {
      font-size: clamp(36px, 7vw, 64px);
      letter-spacing: 1px; font-weight: 800;
    }
    .meaning { font-size: 18px; color: var(--muted); }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: var(--btn-bg); }
    .badge { font-size: 12px; color: var(--muted); }

    /* é¸æ“‡é¡Œ */
    .choices { display: grid; gap: 10px; margin-top: 10px; }
    @media (min-width: 560px){ .choices { grid-template-columns: repeat(2, 1fr); } }
    .choice {
      padding: 14px 16px; border-radius: 12px; border: 1px solid var(--border);
      background: var(--bg); cursor: pointer; font-size: 18px; font-weight: 700; color: var(--fg); /* æ–°å¢ï¼šè®“æŒ‰éˆ•æ–‡å­—è·Ÿè‘—ä¸»é¡Œèµ°ï¼ˆäº®=æ·±è‰²å­—ã€æš—=ç™½å­—ï¼‰ */
    }
    .choice.ok { outline: 2px solid var(--ok); }
    .choice.bad { outline: 2px solid var(--bad); }

    /* è¨˜éŒ„å€ */
    .stats { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }
    .stat { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: var(--btn-bg); font-size: 12px; }

    footer { margin-top: 28px; color: var(--muted); font-size: 12px; text-align: center; }
    .kbd { border: 1px solid var(--border); border-bottom-width: 3px; border-radius: 6px; padding: 2px 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .section {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Flashcard Game</h1>
    <div class="spacer"></div>
    <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œ">ä¸»é¡Œï¼š<span id="themeLabel">äº®è‰²</span></button>
  </header>

  <div class="container">
    <div class="tabs" role="tablist">
      <button class="tab-btn active" role="tab" aria-selected="true" data-tab="flash">é–ƒå¡</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="listen">è½éŸ³è¾¨å­—</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="dict">è½å¯«è¾¨å­—</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="manage">å–®å­—ç®¡ç†</button>
    </div>

    <!-- æ§åˆ¶åˆ—ï¼ˆå…±ç”¨ï¼‰ -->
    <div class="row" style="margin-bottom:12px;">
      <label>å¹´ç´š
        <select class="select" id="levelFilter">
          <option value="ALL">å…¨éƒ¨ï¼ˆKâ€“Grade 6ï¼‰</option>
          <option value="K">Kindergarten (K)</option>
          <option value="G1">Grade 1</option>
          <option value="G2">Grade 2</option>
          <option value="G3">Grade 3</option>
          <option value="G4">Grade 4</option>
          <option value="G5">Grade 5</option>
          <option value="G6">Grade 6</option>
        </select>
      </label>
      <label>èªé€Ÿ
        <input type="range" id="rate" min="0.6" max="1.2" value="0.95" step="0.05" />
      </label>
      <label>éŸ³é«˜
        <input type="range" id="pitch" min="0.8" max="1.4" value="1.0" step="0.05" />
      </label>
      <!-- æ–°å¢ï¼šèªéŸ³é¸æ“‡å™¨ -->
      <label>èªéŸ³
        <select class="select" id="voiceSelect">
          <option>è¼‰å…¥ä¸­â€¦</option>
        </select>
      </label>
      <span id="voiceBadge" class="pill badge" hidden>èªéŸ³ï¼š<span id="voiceName">åµæ¸¬ä¸­â€¦</span></span>
      <button class="btn" id="shuffleBtn">æ´—ç‰Œ</button>
      <span class="hint">å°æŠ€å·§ï¼šæŒ‰ <span class="kbd">ç©ºç™½éµ</span> å¯æ’­æ”¾èªéŸ³ï¼ä¸‹ä¸€é¡Œ</span>
    </div>

    <!-- é–ƒå¡ -->
    <section id="panel-flash" class="panel active">
      <div class="flashcard" id="flashcard" tabindex="0" aria-live="polite">
        <div class="stack">
          <div class="big" id="flashWord">apple</div>
          <div class="meaning" id="flashMeaning">è˜‹æœ</div>
          <div class="controls">
            <button class="btn" id="speakFlash">ğŸ”Š å¿µä¸€æ¬¡</button>
            <button class="btn" id="toggleMeaning">ğŸ™ˆ éš±è—ä¸­æ–‡</button>
            <button class="btn" id="prevBtn">â† ä¸Šä¸€å¼µ</button>
            <button class="btn" id="nextBtn">ä¸‹ä¸€å¼µ â†’</button>
            <button class="btn" id="markKnown">å·²æœƒ âœ…</button>
            <button class="btn" id="markUnknown">ä¸ç†Ÿ â“</button>
          </div>
          <div class="stats">
            <div class="stat">é€²åº¦ï¼š<span id="progress">0/0</span></div>
            <div class="stat">ç†Ÿæ‚‰ï¼š<span id="knownCount">0</span></div>
            <div class="stat">ä¸ç†Ÿï¼š<span id="unknownCount">0</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- è½éŸ³è¾¨å­—ï¼ˆé¸æ“‡é¡Œï¼‰ -->
    <section id="panel-listen" class="panel">
      <div class="section">
        <div class="row">
          <label>é¸é …æ•¸
            <select id="choiceCount" class="select">
              <option>2</option><option selected>3</option><option>4</option>
            </select>
          </label>
          <label class="pill"><input type="checkbox" id="listenOnlyUnknown"> åªç·´ä¸ç†Ÿ</label>
          <button class="btn" id="playListen">ğŸ”Š æ’­æ”¾é¡Œç›®</button>
          <button class="btn" id="nextListen">ä¸‹ä¸€é¡Œ</button>
          <div class="stats">
            <div class="stat">ç­”å°ï¼š<span id="l-correct">0</span></div>
            <div class="stat">ç­”éŒ¯ï¼š<span id="l-wrong">0</span></div>
          </div>
        </div>
        <div class="flashcard" style="min-height: 150px;">
          <div class="stack" style="width:100%;">
            <div id="listenPrompt" class="meaning">æŒ‰ã€Œæ’­æ”¾é¡Œç›®ã€ï¼Œè½éŸ³å¾Œé¸æ­£ç¢ºå–®å­—</div>
            <div class="choices" id="choices"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- è½å¯«è¾¨å­—ï¼ˆæ‰“å­—ï¼‰ -->
    <section id="panel-dict" class="panel">
      <div class="section">
        <div class="row">
          <label class="pill"><input type="checkbox" id="dictOnlyUnknown"> åªç·´ä¸ç†Ÿ</label>
          <button class="btn" id="playDict">ğŸ”Š æ’­æ”¾é¡Œç›®</button>
          <button class="btn" id="revealDict">é¡¯ç¤ºç­”æ¡ˆ</button>
          <button class="btn" id="nextDict">ä¸‹ä¸€é¡Œ</button>
          <div class="stats">
            <div class="stat">æ­£ç¢ºï¼š<span id="d-correct">0</span></div>
            <div class="stat">éŒ¯èª¤ï¼š<span id="d-wrong">0</span></div>
          </div>
        </div>
        <div class="flashcard" style="min-height: 180px;">
          <div class="stack" style="width:100%; place-items:center; text-align:center;">
            <div id="dictPrompt" class="meaning">æŒ‰ã€Œæ’­æ”¾é¡Œç›®ã€ï¼Œè½éŸ³å¾Œæ‹¼å¯«å–®å­—</div>
            <input id="dictInput" type="text" class="select" style="font-size:22px; text-align:center; padding:12px 16px; width:min(460px, 90%);" placeholder="è¼¸å…¥è½åˆ°çš„å–®å­—ï¼ŒæŒ‰ Enter é€å‡º" />
            <div class="row" style="justify-content:center;">
              <button class="btn" id="checkDict">é€å‡º</button>
              <button class="btn" id="hintDict">æç¤ºï¼ˆç¬¬ä¸€å€‹å­—æ¯ï¼‰</button>
            </div>
            <div id="dictFeedback" class="meaning"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- å–®å­—ç®¡ç† -->
    <section id="panel-manage" class="panel">
      <div class="section stack">
        <h3 style="margin:0;">æ–°å¢ï¼ç®¡ç†å–®å­—</h3>
        <div class="row">
          <input id="newWord" type="text" placeholder="è‹±æ–‡å–®å­— (ä¾‹å¦‚: apple)" />
          <input id="newTw" type="text" placeholder="ä¸­æ–‡è§£é‡‹ (ä¾‹å¦‚: è˜‹æœ)" />
          <select id="newLevel" class="select">
            <option value="K">Kindergarten (K)</option>
            <option value="G1">Grade 1</option>
            <option value="G2">Grade 2</option>
            <option value="G3">Grade 3</option>
            <option value="G4">Grade 4</option>
            <option value="G5">Grade 5</option>
            <option value="G6">Grade 6</option>
          </select>
          <button class="btn" id="addWord">åŠ å…¥</button>
        </div>
        <div class="row">
          <button class="btn" id="exportBtn">åŒ¯å‡ºè‡ªè¨‚å–®å­— JSON</button>
          <label class="btn" for="importFile" style="cursor:pointer;">åŒ¯å…¥ JSON</label>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
        <div class="row">
          <button class="btn" id="clearKnown">æ¸…ç©ºã€Œå·²æœƒã€</button>
          <button class="btn" id="clearUnknown">æ¸…ç©ºã€Œä¸ç†Ÿã€</button>
        </div>
        <div class="hint">æç¤ºï¼šè‡ªè¨‚å–®å­—æœƒå„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ (localStorage)ã€‚æ›´æ›è£ç½®æˆ–æ¸…ç©ºç€è¦½è³‡æ–™æœƒæ¶ˆå¤±ï¼Œè«‹è¨˜å¾—åŒ¯å‡ºå‚™ä»½ã€‚</div>
        <div class="stack">
          <h4 style="margin:10px 0 0;">ç›®å‰å–®å­—ï¼ˆä¾ç¾å¼å¹´ç´šç¯©é¸ï¼‰</h4>
          <div id="wordList"></div>
        </div>
      </div>
    </section>

    <footer>Â© 2025 Flashcard Game Â· Liï¼·ei Design</footer>
  </div>

  <script>
    // ====== è³‡æ–™ï¼šåŸºç¤å–®å­—ï¼ˆKâ€“G6ï¼‰ ======
    const BUILTIN_WORDS = [
      // Kindergarten (K)
      {w:'apple',tw:'è˜‹æœ',lv:'K'},{w:'ball',tw:'çƒ',lv:'K'},{w:'cat',tw:'è²“',lv:'K'},
      {w:'dog',tw:'ç‹—',lv:'K'},{w:'egg',tw:'è›‹',lv:'K'},{w:'fish',tw:'é­š',lv:'K'},
      {w:'go',tw:'èµ°ï¼›å»',lv:'K'},{w:'hat',tw:'å¸½å­',lv:'K'},{w:'ice',tw:'å†°',lv:'K'},
      {w:'jam',tw:'æœé†¬',lv:'K'},{w:'kite',tw:'é¢¨ç®',lv:'K'},{w:'lion',tw:'ç…å­',lv:'K'},
      {w:'milk',tw:'ç‰›å¥¶',lv:'K'},{w:'nose',tw:'é¼»å­',lv:'K'},{w:'orange',tw:'æŸ³æ©™',lv:'K'},
      {w:'pig',tw:'è±¬',lv:'K'},{w:'queen',tw:'å¥³ç‹',lv:'K'},{w:'red',tw:'ç´…è‰²',lv:'K'},
      {w:'sun',tw:'å¤ªé™½',lv:'K'},{w:'toy',tw:'ç©å…·',lv:'K'},{w:'up',tw:'å‘ä¸Š',lv:'K'},
      {w:'van',tw:'å»‚å‹è»Š',lv:'K'},{w:'water',tw:'æ°´',lv:'K'},{w:'xray',tw:'X å…‰',lv:'K'},
      {w:'yellow',tw:'é»ƒè‰²',lv:'K'},{w:'zoo',tw:'å‹•ç‰©åœ’',lv:'K'},
      // Grade 1
      {w:'ant',tw:'èèŸ»',lv:'G1'},{w:'bird',tw:'é³¥',lv:'G1'},{w:'blue',tw:'è—è‰²',lv:'G1'},
      {w:'book',tw:'æ›¸',lv:'G1'},{w:'bus',tw:'å…¬è»Š',lv:'G1'},{w:'chair',tw:'æ¤…å­',lv:'G1'},
      {w:'class',tw:'ç­ç´š',lv:'G1'},{w:'door',tw:'é–€',lv:'G1'},{w:'eat',tw:'åƒ',lv:'G1'},
      {w:'friend',tw:'æœ‹å‹',lv:'G1'},{w:'happy',tw:'å¿«æ¨‚çš„',lv:'G1'},{w:'jump',tw:'è·³',lv:'G1'},
      {w:'me',tw:'æˆ‘ï¼ˆå—æ ¼ï¼‰',lv:'G1'},{w:'mom',tw:'åª½åª½',lv:'G1'},{w:'open',tw:'æ‰“é–‹',lv:'G1'},
      {w:'pen',tw:'åŸå­ç­†',lv:'G1'},{w:'pencil',tw:'é‰›ç­†',lv:'G1'},{w:'run',tw:'è·‘',lv:'G1'},
      {w:'school',tw:'å­¸æ ¡',lv:'G1'},{w:'table',tw:'æ¡Œå­',lv:'G1'},{w:'tree',tw:'æ¨¹',lv:'G1'},
      {w:'you',tw:'ä½ ï¼›å¦³ï¼›ä½ å€‘',lv:'G1'},{w:'yes',tw:'æ˜¯ï¼›å¥½',lv:'G1'},{w:'no',tw:'ä¸æ˜¯ï¼›ä¸',lv:'G1'},
      // Grade 2
      {w:'after',tw:'ä¹‹å¾Œ',lv:'G2'},{w:'before',tw:'ä¹‹å‰',lv:'G2'},{w:'bring',tw:'å¸¶ä¾†',lv:'G2'},
      {w:'brown',tw:'æ£•è‰²',lv:'G2'},{w:'cook',tw:'ç…®ï¼›å»šå¸«',lv:'G2'},{w:'draw',tw:'ç•«ç•«',lv:'G2'},
      {w:'drink',tw:'å–ï¼›é£²æ–™',lv:'G2'},{w:'family',tw:'å®¶åº­',lv:'G2'},{w:'far',tw:'é çš„',lv:'G2'},
      {w:'fast',tw:'å¿«çš„',lv:'G2'},{w:'floor',tw:'åœ°æ¿ï¼›æ¨“å±¤',lv:'G2'},{w:'light',tw:'å…‰ï¼›è¼•çš„',lv:'G2'},
      {w:'market',tw:'å¸‚å ´',lv:'G2'},{w:'music',tw:'éŸ³æ¨‚',lv:'G2'},{w:'near',tw:'è¿‘çš„',lv:'G2'},
      {w:'quiet',tw:'å®‰éœçš„',lv:'G2'},{w:'right',tw:'å³é‚Šï¼›æ­£ç¢º',lv:'G2'},{w:'sometimes',tw:'æœ‰æ™‚å€™',lv:'G2'},
      {w:'start',tw:'é–‹å§‹',lv:'G2'},{w:'together',tw:'ä¸€èµ·',lv:'G2'},{w:'under',tw:'åœ¨â€¦ä¹‹ä¸‹',lv:'G2'},
      {w:'wash',tw:'æ´—',lv:'G2'},{w:'watch',tw:'æ‰‹éŒ¶ï¼›è§€çœ‹',lv:'G2'},{w:'white',tw:'ç™½è‰²',lv:'G2'},
      {w:'window',tw:'çª—æˆ¶',lv:'G2'},{w:'yesterday',tw:'æ˜¨å¤©',lv:'G2'},
      // Grade 3
      {w:'animal',tw:'å‹•ç‰©',lv:'G3'},{w:'because',tw:'å› ç‚º',lv:'G3'},{w:'both',tw:'å…©è€…éƒ½',lv:'G3'},
      {w:'climb',tw:'æ”€çˆ¬',lv:'G3'},{w:'cloud',tw:'é›²',lv:'G3'},{w:'country',tw:'åœ‹å®¶ï¼›é„‰é–“',lv:'G3'},
      {w:'finish',tw:'å®Œæˆ',lv:'G3'},{w:'future',tw:'æœªä¾†',lv:'G3'},{w:'health',tw:'å¥åº·',lv:'G3'},
      {w:'hour',tw:'å°æ™‚',lv:'G3'},{w:'important',tw:'é‡è¦çš„',lv:'G3'},{w:'language',tw:'èªè¨€',lv:'G3'},
      {w:'matter',tw:'äº‹æƒ…ï¼›è¦ç·Š',lv:'G3'},{w:'minute',tw:'åˆ†é˜',lv:'G3'},{w:'nature',tw:'è‡ªç„¶',lv:'G3'},
      {w:'promise',tw:'æ‰¿è«¾ï¼›ç­”æ‡‰',lv:'G3'},{w:'reason',tw:'ç†ç”±',lv:'G3'},{w:'season',tw:'å­£ç¯€',lv:'G3'},
      {w:'simple',tw:'ç°¡å–®çš„',lv:'G3'},{w:'slowly',tw:'æ…¢æ…¢åœ°',lv:'G3'},{w:'solution',tw:'è§£æ±ºæ–¹æ³•',lv:'G3'},
      {w:'strong',tw:'å¼·å£¯çš„',lv:'G3'},{w:'through',tw:'ç©¿éï¼›é€é',lv:'G3'},{w:'village',tw:'æ‘èŠ',lv:'G3'},
      {w:'weather',tw:'å¤©æ°£',lv:'G3'},{w:'world',tw:'ä¸–ç•Œ',lv:'G3'},
      // Grade 4
      {w:'accident',tw:'æ„å¤–ï¼›äº‹æ•…',lv:'G4'},{w:'afraid',tw:'å®³æ€•çš„',lv:'G4'},{w:'already',tw:'å·²ç¶“',lv:'G4'},
      {w:'bottle',tw:'ç“¶å­',lv:'G4'},{w:'bridge',tw:'æ©‹',lv:'G4'},{w:'calendar',tw:'æ—¥æ›†',lv:'G4'},
      {w:'careful',tw:'å°å¿ƒçš„',lv:'G4'},{w:'circle',tw:'åœ“å½¢',lv:'G4'},{w:'comfortable',tw:'èˆ’æœçš„',lv:'G4'},
      {w:'cousin',tw:'å ‚ï¼è¡¨å…„å¼Ÿå§Šå¦¹',lv:'G4'},{w:'danger',tw:'å±éšª',lv:'G4'},{w:'delicious',tw:'å¥½åƒçš„',lv:'G4'},
      {w:'describe',tw:'æè¿°',lv:'G4'},{w:'energy',tw:'èƒ½é‡',lv:'G4'},{w:'exercise',tw:'é‹å‹•ï¼›é›éŠ',lv:'G4'},
      {w:'festival',tw:'ç¯€æ—¥',lv:'G4'},{w:'foreign',tw:'å¤–åœ‹çš„',lv:'G4'},{w:'garbage',tw:'åƒåœ¾',lv:'G4'},
      {w:'grass',tw:'è‰',lv:'G4'},{w:'history',tw:'æ­·å²',lv:'G4'},{w:'island',tw:'å³¶å¶¼',lv:'G4'},
      {w:'invite',tw:'é‚€è«‹',lv:'G4'},{w:'mirror',tw:'é¡å­',lv:'G4'},{w:'paper',tw:'ç´™ï¼›å ±ç´™',lv:'G4'},
      {w:'repair',tw:'ä¿®ç†',lv:'G4'},
      // Grade 5
      {w:'advice',tw:'å»ºè­°',lv:'G5'},{w:'ancient',tw:'å¤è€çš„',lv:'G5'},{w:'arrive',tw:'åˆ°é”',lv:'G5'},
      {w:'attention',tw:'æ³¨æ„',lv:'G5'},{w:'battle',tw:'æˆ°é¬¥',lv:'G5'},{w:'beach',tw:'æµ·ç˜',lv:'G5'},
      {w:'believe',tw:'ç›¸ä¿¡',lv:'G5'},{w:'career',tw:'è·æ¥­ï¼›ç”Ÿæ¶¯',lv:'G5'},{w:'century',tw:'ä¸–ç´€',lv:'G5'},
      {w:'chemical',tw:'åŒ–å­¸çš„ï¼›åŒ–å­¸å“',lv:'G5'},{w:'company',tw:'å…¬å¸',lv:'G5'},{w:'courage',tw:'å‹‡æ°£',lv:'G5'},
      {w:'culture',tw:'æ–‡åŒ–',lv:'G5'},{w:'custom',tw:'ç¿’ä¿—',lv:'G5'},{w:'damage',tw:'æå®³',lv:'G5'},
      {w:'effect',tw:'æ•ˆæœï¼›å½±éŸ¿',lv:'G5'},{w:'electric',tw:'é›»çš„',lv:'G5'},{w:'excellent',tw:'å„ªç§€çš„',lv:'G5'},
      {w:'factory',tw:'å·¥å» ',lv:'G5'},{w:'famous',tw:'æœ‰åçš„',lv:'G5'},{w:'general',tw:'ä¸€èˆ¬çš„ï¼›å°‡è»',lv:'G5'},
      {w:'government',tw:'æ”¿åºœ',lv:'G5'},{w:'human',tw:'äººé¡ï¼›äººçš„',lv:'G5'},{w:'illness',tw:'ç–¾ç—…',lv:'G5'},
      {w:'invention',tw:'ç™¼æ˜',lv:'G5'},
      // Grade 6
      {w:'achievement',tw:'æˆå°±',lv:'G6'},{w:'architecture',tw:'å»ºç¯‰',lv:'G6'},{w:'atmosphere',tw:'å¤§æ°£ï¼›æ°£æ°›',lv:'G6'},
      {w:'behavior',tw:'è¡Œç‚º',lv:'G6'},{w:'challenge',tw:'æŒ‘æˆ°',lv:'G6'},{w:'community',tw:'ç¤¾å€',lv:'G6'},
      {w:'competition',tw:'ç«¶çˆ­',lv:'G6'},{w:'conclusion',tw:'çµè«–',lv:'G6'},{w:'conservation',tw:'ä¿è‚²ï¼›ç¯€ç´„',lv:'G6'},
      {w:'continent',tw:'å¤§é™¸ï¼›æ´²',lv:'G6'},{w:'cooperation',tw:'åˆä½œ',lv:'G6'},{w:'discovery',tw:'ç™¼ç¾',lv:'G6'},
      {w:'education',tw:'æ•™è‚²',lv:'G6'},{w:'environment',tw:'ç’°å¢ƒ',lv:'G6'},{w:'evidence',tw:'è­‰æ“š',lv:'G6'},
      {w:'experiment',tw:'å¯¦é©—',lv:'G6'},{w:'independent',tw:'ç¨ç«‹çš„',lv:'G6'},{w:'influence',tw:'å½±éŸ¿',lv:'G6'},
      {w:'international',tw:'åœ‹éš›çš„',lv:'G6'},{w:'literature',tw:'æ–‡å­¸',lv:'G6'},{w:'population',tw:'äººå£',lv:'G6'},
      {w:'principle',tw:'åŸå‰‡',lv:'G6'},{w:'responsible',tw:'è² è²¬çš„',lv:'G6'},{w:'solution',tw:'è§£æ±ºæ–¹æ³•',lv:'G6'},
      {w:'technology',tw:'ç§‘æŠ€',lv:'G6'}
    ];

    // ====== å·¥å…· & å„²å­˜ ======
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const STORAGE_KEYS = {
      THEME: 'fc-theme',
      CUSTOM: 'fc-custom-words',
      KNOWN: 'fc-known',
      UNKNOWN: 'fc-unknown',
      VOICE: 'fc-voice' // æ–°å¢ï¼šè¨˜ä½èªéŸ³åå¥½
    };
    function loadTheme(){
      const saved = localStorage.getItem(STORAGE_KEYS.THEME) || 'light';
      document.documentElement.setAttribute('data-theme', saved === 'dark' ? 'dark' : 'light');
      $('#themeLabel').textContent = saved === 'dark' ? 'æ·±è‰²' : 'äº®è‰²';
    }
    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      const next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      $('#themeLabel').textContent = next === 'dark' ? 'æ·±è‰²' : 'äº®è‰²';
      localStorage.setItem(STORAGE_KEYS.THEME, next);
    }
    function getCustomWords(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOM)||'[]'); }catch{ return []; } }
    function saveCustomWords(list){ localStorage.setItem(STORAGE_KEYS.CUSTOM, JSON.stringify(list)); }
    function allWords(){ return [...BUILTIN_WORDS, ...getCustomWords()].sort((a,b)=> a.w.localeCompare(b.w)); }
    function getKnown(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.KNOWN)||'[]'); }catch{ return []; } }
    function getUnknown(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.UNKNOWN)||'[]'); }catch{ return []; } }
    function addToList(key, w){
      const set = new Set(JSON.parse(localStorage.getItem(key) || '[]'));
      set.add(w); localStorage.setItem(key, JSON.stringify([...set]));
    }
    function clearList(key){ localStorage.removeItem(key); }

    function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    // ====== èªéŸ³ï¼ˆTTSï¼‰ ======
    let VOICES = [];
    function pickVoice(){
      const sel = document.querySelector('#voiceSelect');
      if(sel && VOICES.length){
        const i = parseInt(sel.value, 10) || 0;
        return VOICES[i] || VOICES[0] || null;
      }
      return VOICES[0] || null;
    }
    function speak(text){
      if(!('speechSynthesis' in window)) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€ã€‚');
      const u = new SpeechSynthesisUtterance(text);
      u.rate = parseFloat($('#rate').value);
      u.pitch = parseFloat($('#pitch').value);
      const v = pickVoice(); if(v) u.voice = v;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
    function initVoices(){
      VOICES = window.speechSynthesis.getVoices();
      // åªåˆ—è‹±æ–‡èªéŸ³ï¼ˆè‹¥æ²’æœ‰è‹±æ–‡å‰‡ä¿ç•™å…¨éƒ¨ï¼‰
      const en = VOICES.filter(v => /^en([-_]|$)/i.test(v.lang));
      if(en.length) VOICES = en;

      const sel = document.querySelector('#voiceSelect');
      if(!sel) return;

      sel.innerHTML = VOICES.map((v, i) => `<option value="${i}">${v.name} Â· ${v.lang}</option>`).join('') || '<option>æœªæ‰¾åˆ°èªéŸ³</option>';

      const savedName = localStorage.getItem(STORAGE_KEYS.VOICE);
      const prefs = ['en-US','en-GB','en-AU','en-CA'];
      let index = 0;

      if(savedName){
        const k = VOICES.findIndex(v => v.name === savedName);
        if(k >= 0) index = k;
      }else{
        for(const p of prefs){
          const k = VOICES.findIndex(v => v.lang.startsWith(p));
          if(k >= 0){ index = k; break; }
        }
      }

      sel.value = String(index);
      const v = VOICES[index];
      $('#voiceName').textContent = v ? `${v.name} Â· ${v.lang}` : 'æœªæ‰¾åˆ°èªéŸ³';
    }
    window.speechSynthesis?.addEventListener('voiceschanged', initVoices);

    // ====== ç‹€æ…‹ ======
    let currentTab = 'flash';
    let pool = []; let order = []; let idx = 0;
    let listenAnswer = null, lCorrect = 0, lWrong = 0;
    let dictAnswer = null, dCorrect = 0, dWrong = 0;

    // ====== å¹´ç´šéæ¿¾ï¼ˆç¾å¼ï¼‰ ======
    function byLevel(list){
      const lv = $('#levelFilter').value;
      return lv === 'ALL' ? list : list.filter(x=> x.lv === lv);
    }
    function sourceForMode(base){
      if((currentTab==='listen' && $('#listenOnlyUnknown')?.checked) ||
         (currentTab==='dict' && $('#dictOnlyUnknown')?.checked)){
        const unk = new Set(getUnknown());
        return base.filter(x=> unk.has(x.w));
      }
      return base;
    }
    function refreshPool(){
      pool = sourceForMode(byLevel(allWords()));
      order = pool.map((_,i)=>i); shuffle(order); idx = 0;
      renderFlash(); renderWordList(); resetListen(); resetDict();
    }

    // ====== é–ƒå¡ ======
    function renderFlash(){
      if(pool.length === 0){
        $('#flashWord').textContent = 'ï¼ˆæ­¤å¹´ç´šç›®å‰æ²’æœ‰å–®å­—ï¼‰';
        $('#flashMeaning').textContent = 'è«‹åˆ‡æ›å¹´ç´šï¼Œæˆ–åˆ°ã€Œå–®å­—ç®¡ç†ã€æ–°å¢å–®å­—ã€‚';
        $('#progress').textContent = '0/0';
        $('#knownCount').textContent = getKnown().length;
        $('#unknownCount').textContent = getUnknown().length;
        return;
      }
      const i = order[idx], item = pool[i];
      $('#flashWord').textContent = item.w;
      $('#flashMeaning').textContent = item.tw;
      $('#progress').textContent = `${idx+1}/${order.length}`;
      $('#knownCount').textContent = getKnown().length;
      $('#unknownCount').textContent = getUnknown().length;
    }
    function nextFlash(){ if(pool.length){ idx = (idx+1)%order.length; renderFlash(); } }
    function prevFlash(){ if(pool.length){ idx = (idx-1+order.length)%order.length; renderFlash(); } }
    function toggleMeaning(){
      const el = $('#flashMeaning');
      const hidden = el.style.visibility === 'hidden';
      el.style.visibility = hidden ? 'visible' : 'hidden';
      $('#toggleMeaning').textContent = hidden ? 'ğŸ™ˆ éš±è—ä¸­æ–‡' : 'ğŸ‘€ é¡¯ç¤ºä¸­æ–‡';
    }

    // ====== è½éŸ³è¾¨å­— ======
    function resetListen(){
      listenAnswer = null;
      $('#listenPrompt').textContent = 'æŒ‰ã€Œæ’­æ”¾é¡Œç›®ã€ï¼Œè½éŸ³å¾Œé¸æ­£ç¢ºå–®å­—';
      $('#choices').innerHTML = '';
    }
    function currentPool(){ return sourceForMode(byLevel(allWords())); }
    function newListenQuestion(){
      const list = currentPool(); if(list.length === 0){ resetListen(); return; }
      const count = parseInt($('#choiceCount').value, 10);
      const answer = sample(list); listenAnswer = answer.w;
      $('#listenPrompt').textContent = 'è«‹é¸å‡ºå‰›å‰›è½åˆ°çš„å–®å­—';
      const others = list.filter(x=> x.w !== answer.w); shuffle(others);
      const options = shuffle([answer.w, ...others.slice(0, Math.max(1,count-1)).map(x=>x.w)]);
      const box = $('#choices'); box.innerHTML = '';
      options.forEach(opt=>{
        const btn = document.createElement('button');
        btn.className = 'choice'; btn.textContent = opt;
        btn.addEventListener('click', ()=>{
          if(opt === listenAnswer){
            btn.classList.add('ok'); lCorrect++; $('#l-correct').textContent = lCorrect;
            addToList(STORAGE_KEYS.KNOWN, opt);
          }else{
            btn.classList.add('bad'); lWrong++; $('#l-wrong').textContent = lWrong;
            addToList(STORAGE_KEYS.UNKNOWN, listenAnswer);
          }
        }, {once:true});
        btn.addEventListener('mouseenter', ()=> speak(opt));
        box.appendChild(btn);
      });
      speak(answer.w);
    }

    // ====== è½å¯«è¾¨å­— ======
    function resetDict(){
      dictAnswer = null;
      $('#dictPrompt').textContent = 'æŒ‰ã€Œæ’­æ”¾é¡Œç›®ã€ï¼Œè½éŸ³å¾Œæ‹¼å¯«å–®å­—';
      $('#dictFeedback').textContent = '';
      $('#dictInput').value = '';
    }
    function newDictQuestion(){
      const list = currentPool(); if(list.length === 0){ resetDict(); return; }
      const item = sample(list); dictAnswer = item.w;
      $('#dictPrompt').textContent = 'è«‹è½éŸ³æ‹¼å¯«ä¸¦é€å‡º';
      $('#dictFeedback').textContent = ''; $('#dictInput').value = ''; $('#dictInput').focus();
      speak(item.w);
    }
    function checkDict(){
      const val = ($('#dictInput').value || '').trim().toLowerCase();
      if(!dictAnswer) return;
      if(val === dictAnswer.toLowerCase()){
        $('#dictFeedback').textContent = 'âœ… æ­£ç¢ºï¼'; $('#dictFeedback').style.color = 'var(--ok)';
        dCorrect++; $('#d-correct').textContent = dCorrect;
        addToList(STORAGE_KEYS.KNOWN, dictAnswer);
      }else{
        $('#dictFeedback').textContent = `âŒ å†è©¦è©¦çœ‹ï¼æ­£ç¢ºç­”æ¡ˆï¼š${dictAnswer}`; $('#dictFeedback').style.color = 'var(--bad)';
        dWrong++; $('#d-wrong').textContent = dWrong;
        addToList(STORAGE_KEYS.UNKNOWN, dictAnswer);
      }
    }

    // ====== å–®å­—ç®¡ç† ======
    function renderWordList(){
      const target = $('#wordList'); const words = byLevel(allWords());
      if(words.length === 0){ target.innerHTML = '<div class="hint">æ­¤å¹´ç´šæ²’æœ‰è³‡æ–™ã€‚</div>'; return; }
      const groups = words.reduce((acc, x)=>{ (acc[x.lv] ||= []).push(x); return acc; }, {});
      let html = '';
      for(const lv of Object.keys(groups)){
        const title = ({K:'Kindergarten (K)',G1:'Grade 1',G2:'Grade 2',G3:'Grade 3',G4:'Grade 4',G5:'Grade 5',G6:'Grade 6'})[lv] || lv;
        const arr = groups[lv].sort((a,b)=> a.w.localeCompare(b.w));
        html += `<div style="margin:.5rem 0;"><div class="badge">å¹´ç´šï¼š${title}</div>`;
        html += '<div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">';
        arr.forEach(x=>{ html += `<span class="pill">${x.w}<span class="hint">ï¼ˆ${x.tw}ï¼‰</span></span>`; });
        html += '</div></div>';
      }
      target.innerHTML = html;
    }

    // ====== äº‹ä»¶ç¹«çµ ======
    function bind(){
      // tabs
      $$('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('.tab-btn').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active'); currentTab = btn.dataset.tab;
          $$('.panel').forEach(p=> p.classList.remove('active'));
          $('#panel-'+currentTab).classList.add('active');
        });
      });

      // theme
      $('#themeToggle').addEventListener('click', toggleTheme);

      // filters
      $('#levelFilter').addEventListener('change', refreshPool);

      // voice selectï¼ˆè¨˜ä½åå¥½ï¼‰
      const voiceSel = document.querySelector('#voiceSelect');
      if(voiceSel){
        voiceSel.addEventListener('change', () => {
          const v = pickVoice();
          if(v){
            $('#voiceName').textContent = `${v.name} Â· ${v.lang}`;
            localStorage.setItem(STORAGE_KEYS.VOICE, v.name);
          }
        });
      }

      // flash controls
      $('#shuffleBtn').addEventListener('click', ()=>{ shuffle(order); idx=0; renderFlash(); });
      $('#nextBtn').addEventListener('click', nextFlash);
      $('#prevBtn').addEventListener('click', prevFlash);
      $('#toggleMeaning').addEventListener('click', toggleMeaning);
      $('#speakFlash').addEventListener('click', ()=>{ if(pool.length){ speak(pool[order[idx]].w); } });
      $('#markKnown').addEventListener('click', ()=>{ if(pool.length){ addToList(STORAGE_KEYS.KNOWN, pool[order[idx]].w); renderFlash(); } });
      $('#markUnknown').addEventListener('click', ()=>{ if(pool.length){ addToList(STORAGE_KEYS.UNKNOWN, pool[order[idx]].w); renderFlash(); } });

      // listen
      $('#playListen').addEventListener('click', newListenQuestion);
      $('#nextListen').addEventListener('click', newListenQuestion);
      $('#listenOnlyUnknown').addEventListener('change', refreshPool);

      // dict
      $('#playDict').addEventListener('click', newDictQuestion);
      $('#nextDict').addEventListener('click', newDictQuestion);
      $('#checkDict').addEventListener('click', checkDict);
      $('#dictOnlyUnknown').addEventListener('change', refreshPool);
      $('#dictInput').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ checkDict(); } });
      $('#hintDict').addEventListener('click', ()=>{
        if(!dictAnswer) return;
        const hint = dictAnswer[0] + ' ' + '_ '.repeat(Math.max(dictAnswer.length-1,1)).trim();
        $('#dictFeedback').textContent = `æç¤ºï¼š${hint}`;
        $('#dictFeedback').style.color = 'var(--muted)';
      });
      $('#revealDict').addEventListener('click', ()=>{
        if(!dictAnswer) return;
        $('#dictFeedback').textContent = `ç­”æ¡ˆï¼š${dictAnswer}`;
        $('#dictFeedback').style.color = 'var(--primary)';
        speak(dictAnswer);
      });

      // manage
      $('#addWord').addEventListener('click', ()=>{
        const w = ($('#newWord').value||'').trim();
        const tw = ($('#newTw').value||'').trim();
        const lv = $('#newLevel').value;
        if(!w || !tw) return alert('è«‹è¼¸å…¥è‹±æ–‡èˆ‡ä¸­æ–‡ã€‚');
        const all = getCustomWords();
        if(all.some(x=> x.w.toLowerCase() === w.toLowerCase())){ return alert('æ­¤å–®å­—å·²å­˜åœ¨æ–¼è‡ªè¨‚æ¸…å–®ã€‚'); }
        all.push({w, tw, lv}); saveCustomWords(all);
        $('#newWord').value = ''; $('#newTw').value='';
        refreshPool(); alert('å·²åŠ å…¥ï¼');
      });

      $('#exportBtn').addEventListener('click', ()=>{
        const data = JSON.stringify(getCustomWords(), null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'my-words.json'; a.click();
        URL.revokeObjectURL(url);
      });
      $('#importFile').addEventListener('change', (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const arr = JSON.parse(reader.result);
            if(!Array.isArray(arr)) throw new Error('æ ¼å¼éŒ¯èª¤');
            const sanitized = arr
              .filter(x=> x && typeof x.w==='string' && typeof x.tw==='string' && ['K','G1','G2','G3','G4','G5','G6'].includes(x.lv))
              .map(x=> ({w:x.w.trim(), tw:x.tw.trim(), lv:x.lv}));
            saveCustomWords(sanitized); refreshPool(); alert('åŒ¯å…¥å®Œæˆï¼');
          }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message); }
        };
        reader.readAsText(file); e.target.value = '';
      });

      $('#clearKnown').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šæ¸…ç©ºã€Œå·²æœƒã€æ¸…å–®ï¼Ÿ')){ clearList(STORAGE_KEYS.KNOWN); renderFlash(); } });
      $('#clearUnknown').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šæ¸…ç©ºã€Œä¸ç†Ÿã€æ¸…å–®ï¼Ÿ')){ clearList(STORAGE_KEYS.UNKNOWN); renderFlash(); } });

      // å¿«æ·éµ
      window.addEventListener('keydown', (e)=>{
        if(e.code === 'Space'){
          e.preventDefault();
          if(currentTab === 'flash'){
          nextFlash();                     // å…ˆæ›åˆ°ä¸‹ä¸€å¼µ
          speak(pool[order[idx]].w);       // æ’­æ”¾æ–°é¡¯ç¤ºçš„å­—
          }else if(currentTab === 'listen'){
            newListenQuestion();
          }else if(currentTab === 'dict'){
            if(dictAnswer){ checkDict(); } else { newDictQuestion(); }
          }
        }else if(currentTab==='flash' && (e.key==='ArrowRight' || e.key==='ArrowLeft')){
          e.key==='ArrowRight' ? nextFlash() : prevFlash();
        }
      });
    }

    // ====== åˆå§‹åŒ– ======
    function init(){
      loadTheme(); initVoices();
      if(('speechSynthesis' in window) && VOICES.length === 0){ setTimeout(initVoices, 200); }
      bind(); refreshPool();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
