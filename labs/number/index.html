<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>自動車登録番号標</title>
  <style>
    :root{ 
      --plate-width: 990px; 
      --plate-height: 495px; 
      --radius: 30px; 
      --edge: 14px; 
      --green: #136f2d; 
      --white: #ffffff; 
      --yellow: #ffd400; 
      --black: #111111; }
    *{ box-sizing: border-box; }
    body{
      font-family: "Noto Sans JP","Hiragino Sans","Yu Gothic UI","Yu Gothic","MS Gothic","PingFang TC","Noto Sans TC",Arial,Helvetica,sans-serif;
      margin: 0; 
      padding: 24px; 
      background: #f6f7f9; 
      color: #222; 
      line-height: 1.4;
    }
    h1{ 
      margin: 0 0 12px 0; 
      font-size: 20px; 
    }
    .app{ 
      display: grid; 
      grid-template-columns: 360px 1fr; 
      gap: 24px; 
      align-items: start; 
    }
    @media (max-width: 1024px){ .app{ grid-template-columns: 1fr; } }
    .panel{ 
      background: #fff; 
      border-radius: 16px; 
      box-shadow: 0 6px 18px rgba(0,0,0,.08); 
      padding: 16px; 
    }
    .controls .row{ 
      display:flex; 
      gap:12px; 
      margin-bottom: 10px; 
    }
    .controls label{ 
      font-size: 12px; 
      color:#555; 
      display:block; 
      margin-bottom:4px; 
    }
    .controls input[type="text"], 
    .controls input[type="number"], 
    .controls select{
      width: 100%; 
      font-size: 14px; 
      padding: 10px 12px; 
      border: 1px solid #d9dde5; 
      border-radius: 10px; 
      background: #fbfbfc; 
      outline: none; 
      color: #111;
    }
    .muted{ 
      font-size: 12px; 
      color:#6b7280; 
    }
    .btns{ 
      display:flex; 
      gap:10px; 
      flex-wrap: wrap; 
      margin-top: 8px; 
    }
    button{ 
      appearance: none; 
      border: 0; 
      border-radius: 10px; 
      padding: 10px 14px; 
      background: #1f6feb; 
      color: white; 
      font-weight: 600; 
      cursor: pointer; 
    }
    button.secondary{ 
      background:#e5e7eb; 
      color:#111; 
    }
    button.warning{ 
      background:#16a34a; 
    }
    .stage{ 
      display:flex; 
      justify-content:center; 
      align-items:center; 
      padding: 18px; 
    }
    svg{ 
      width: min(100%, var(--plate-width)); 
      height: auto; display:block; 
      border-radius: var(--radius); 
      background: #ddd; 
    }
    .plate{ 
      rx: var(--radius); 
      ry: var(--radius); 
      stroke:#111; 
      stroke-width:2; 
    }
    .inner{ 
      rx: calc(var(--radius) - var(--edge)); 
      ry: calc(var(--radius) - var(--edge)); 
      stroke-width: 8; 
    }
    .top-line{ 
      font-weight: 700; 
    }
    .office{ 
      font-size: 100px; 
    }
    .class-code{ 
      font-size: 110px; 
      letter-spacing: 3px; 
    }
    .bottom-line{ 
      font-weight: 800; 
    }
    .kana{ 
      font-size: 100px; 
    }
    .serial{ 
      font-size: 190px; 
      letter-spacing: 8px; 
    }
    .bolt{ 
      fill:#d7dbe2; 
      stroke:#9aa4b2; 
      stroke-width:4; 
    }
    .seal{ 
      fill:#0ea5e9; 
      opacity:.85; 
    }
    .legend{ 
      font-size: 12px; 
      color:#6b7280; 
      margin-top:6px; 
    }
    .colorchip{ 
      display:inline-block; 
      width:12px; 
      height:12px; 
      border-radius:3px; 
      margin-right:6px; 
      vertical-align: -2px; 
      border:1px solid #ccc;
    }
    .row.inline > *{ 
      flex:1; 
    }
    
    /* 英字改併入分類番号 */
    #smallSuffixText{ display:none; } 
  </style>
</head>
<body>
  <h1>自動車登録番号標</h1>
  <div class="app">
    <div class="panel controls">
      <div class="row inline">
        <div>
          <label>プレート種別／色</label>
          <select id="plateType">
            <option value="private">自家用（白地・緑文字）</option>
            <option value="commercial">事業用（緑地・白文字）</option>
            <option value="kei_private">軽自動車・自家用（黄地・黒文字）</option>
            <option value="kei_commercial">軽自動車・事業用（黒地・黄文字）</option>
          </select>
        </div>
        <div>
          <label>発給地（上段左：運輸支局／地名 例：品川・足立・横浜）</label>
          <input id="office" type="text" value="品川" maxlength="6" placeholder="例：品川／足立／横浜／名古屋">
        </div>
      </div>

      <div class="row inline">
        <div>
          <label>分類番号（上段右：2～3桁 例：500、330）</label>
          <input id="classCode" type="text" value="500" pattern="[0-9A-Za-z]{2,3}" maxlength="3">
          <div class="muted">1桁目は用途区分：1=大型貨物、2=バス、3=&gt;2000cc 乗用、5=≦2000cc 乗用、8=特殊 など。</div>
        </div>
        <div>
          <label>仮名（下段左：ひらがな1文字 例：あ／わ）</label>
          <input id="kana" type="text" value="あ" maxlength="1">
          <div class="muted">一部の仮名は保留／未使用（例：わ=レンタカー、 お・し・へ・ん は多くの地域で不使用）。</div>
        </div>
      </div>

      <div class="row inline">
        <div>
          <label>一連指定番号（下段右：4桁。2–2のハイフンは自動）</label>
          <input id="serial" type="number" value="1234" min="0" max="9999" step="1">
        </div>
        <div>
          <label>分類番号の英字（必要な場合 例：A）</label>
          <input id="smallSuffix" type="text" value="" maxlength="1" placeholder="空欄可">
        </div>
      </div>

      <div class="btns">
        <button id="randomBtn" class="secondary">乱数</button>
        <button id="policeNormalBtn" class="secondary">警察車両（普通）</button>
        <button id="policeKeiBtn" class="secondary">警察車両（軽）</button>
        <button id="downloadPngBtn" class="secondary">PNG保存 </button>
        <button id="downloadSvgBtn" class="secondary">SVG保存</button>
      </div>

      <p class="legend">
        <span class="colorchip" style="background:#fff;border:1px solid #136f2d"></span>白地・緑文字（自家用）
        <span class="colorchip" style="background:#136f2d"></span><span class="colorchip" style="background:#fff"></span>緑地・白文字（事業用）
        <span class="colorchip" style="background:#ffd400"></span><span class="colorchip" style="background:#111"></span>黄地・黒文字（軽・自家用）
        <span class="colorchip" style="background:#111"></span><span class="colorchip" style="background:#ffd400"></span>黒地・黄文字（軽・事業用）
      </p>
    </div>

    <div class="panel stage">
      <svg id="plateSvg" viewBox="0 0 990 495" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="ナンバープレート プレビュー">
        <!-- 外框 -->
        <rect x="3" y="3" width="984" height="489" class="plate" fill="white"/>
        <rect x="25" y="25" width="940" height="445" class="inner" fill="none" stroke="#136f2d"/>
        <!-- 螺絲與封印 -->
        <circle class="bolt" cx="120" cy="90" r="20"/>
        <circle class="bolt" cx="870" cy="90" r="20"/>
        <circle class="seal" cx="870" cy="90" r="12"/>
        <!-- 上排：發牌地 + 類別番号（含英字） -->
        <text id="officeText" class="top-line office" x="250" y="155" fill="#136f2d">品川</text>
        <text id="classCodeText" class="top-line class-code" x="720" y="155" fill="#136f2d" text-anchor="end">500</text>
        <text id="smallSuffixText" class="top-line" x="652" y="90" fill="#136f2d" font-size="64" font-weight="800"> </text> <!-- 已用 CSS 隱藏 -->
        <!-- 下排：假名 + 序號 -->
        <text id="kanaText" class="bottom-line kana" x="90" y="365" fill="#136f2d">あ</text>
        <text id="serialText" class="bottom-line serial" x="940" y="380" fill="#136f2d" text-anchor="end">12-34</text>
      </svg>
    </div>
  </div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const office = $("#office");
    const classCode = $("#classCode");
    const kana = $("#kana");
    const serial = $("#serial");
    const smallSuffix = $("#smallSuffix");
    const plateType = $("#plateType");

    const officeText = $("#officeText");
    const classCodeText = $("#classCodeText");
    const kanaText = $("#kanaText");
    const serialText = $("#serialText");
    const smallSuffixText = $("#smallSuffixText");
    const plateRect = document.querySelector("rect.plate");
    const innerRect = document.querySelector("rect.inner");

    const fills = {
      private:     { bg: "#ffffff", fg: "#136f2d" },
      commercial:  { bg: "#136f2d", fg: "#ffffff" },
      kei_private: { bg: "#ffd400", fg: "#111111" },
      kei_commercial:{ bg: "#111111", fg: "#ffd400" },
    };

    function updateColors(){
      const {bg, fg} = fills[plateType.value];
      plateRect.setAttribute("fill", bg);
      innerRect.setAttribute("stroke", (plateType.value==="commercial"||plateType.value==="kei_commercial") ? bg : fg);
      officeText.setAttribute("fill", fg);
      classCodeText.setAttribute("fill", fg);
      smallSuffixText.setAttribute("fill", fg);
      kanaText.setAttribute("fill", fg);
      serialText.setAttribute("fill", fg);
    }

    function normalizeClassCode(v){
      v = (v || "").toUpperCase().replace(/[^0-9A-Z]/g,"").slice(0,3);
      if(v.length<2) v="50".slice(0,2);
      return v;
    }
    function composeClassCode(cc, letter){
      let L = (letter||"").toUpperCase().replace(/[^ACFHKLMPXY]/g,"").slice(0,1);
      if(!L) return cc;
      if(cc.length>=3) return cc.slice(0,2) + L;
      if(cc.length===2) return cc + L;
      return cc;
    }
    
    function formatSerial(n){
      let s = String(Math.max(0, Math.min(9999, parseInt(n,10) || 0))).padStart(4,"0");
      const leadZeros = s.match(/^0+/);
      if(leadZeros){
        const dots = "・".repeat(leadZeros[0].length);
        s = dots + s.slice(leadZeros[0].length);
      }
      return s.slice(0,2) + "-" + s.slice(2); 
    }

    function normalizeKana(k){
      if(!k) return "あ";
      const ch = [...k][0];
      return ch;
    }

    // 讓上排「地名」與「類別番号」固定最小間距避免重疊
    function layoutTopLine(minGap = 20){
      const innerLeft = 25, innerWidth = 940, rightMargin = 30;
      const maxRight = innerLeft + innerWidth - rightMargin;   // 965-30=935
      const baseRight = 720;                                    
      const officeX = parseFloat(officeText.getAttribute('x')) || 0;
      const officeRight = officeX + officeText.getBBox().width; // 地名右邊界
      const codeWidth = classCodeText.getBBox().width;          // 番號寬度
      let desiredRight = Math.max(baseRight, officeRight + minGap + codeWidth);
      if (desiredRight > maxRight) desiredRight = maxRight;
      classCodeText.setAttribute('x', desiredRight);
    }

    function update(){
      officeText.textContent = office.value || "品川";
      const cc = normalizeClassCode(classCode.value);
      classCodeText.textContent = composeClassCode(cc, smallSuffix.value);
      kanaText.textContent = normalizeKana(kana.value);
      serialText.textContent = formatSerial(serial.value);
      updateColors();
      layoutTopLine();
    }

    // 警用預設
    function applyPolicePreset({type="normal", marked=true} = {}){     
        plateType.value = (type === "kei") ? "kei_private" : "private";

        // 分類番号：標示車偏向 800，覆面車偏向 3xx/5xx
  classCode.value = marked
    ? randOf(["800","800","300","500","530"])   // 讓 800 比例高一點
    : randOf(["300","330","500","530"]);

  // 假名：自家用集合，排除租賃/不使用的假名
  const banned = new Set(["わ","お","し","へ","ん","れ"]); // 視需要保留/刪去「れ」
  const pool = [..."さすせそたちつてとなにぬねのはひふほまみむめもやゆよらりるろ"]
               .filter(k => !banned.has(k));
  kana.value = randOf(pool);
      
      update();
    }

    // === 匯出：把必要樣式內嵌到 SVG ===
    function buildSvgForExport(){
      const src = document.getElementById('plateSvg');
      const svg = src.cloneNode(true);
      svg.setAttribute('xmlns','http://www.w3.org/2000/svg');
      svg.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');

      const plateRect = svg.querySelector('rect.plate');
      const innerRect = svg.querySelector('rect.inner');
      if (plateRect){ plateRect.setAttribute('rx','30'); plateRect.setAttribute('ry','30'); }
      if (innerRect){ innerRect.setAttribute('rx','16'); innerRect.setAttribute('ry','16'); }

      const style = document.createElement('style');
      style.textContent = `
        svg text{ font-family:"Noto Sans JP","Yu Gothic","MS Gothic",sans-serif; }
        #smallSuffixText{ display:none; }
        .top-line{ font-weight:700; }
        .bottom-line{ font-weight:800; }
        .office{ font-size:100px; }
        .class-code{ font-size:110px; letter-spacing:3px; }
        .kana{ font-size:100px; }
        .serial{ font-size:190px; letter-spacing:8px; }
      `;
      svg.insertBefore(style, svg.firstChild);

      // 確保分類番号（含英字）與序號皆為現值
      const cc = normalizeClassCode(classCode.value);
      svg.querySelector('#classCodeText').textContent = composeClassCode(cc, smallSuffix.value);
      svg.querySelector('#serialText').textContent = formatSerial(serial.value);

      return new XMLSerializer().serializeToString(svg);
    }

    function download(filename, content, type="image/svg+xml"){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    function downloadSVG(){
      const svgData = buildSvgForExport();
      download("jp-plate.svg", svgData);
    }

    function downloadPNG(){
      const svgData = buildSvgForExport();
      const svgBlob = new Blob([svgData], {type: "image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      img.onload = function(){
        const scale = 2;
        const canvas = document.createElement("canvas");
        canvas.width = 990 * scale;
        canvas.height = 495 * scale;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);
        canvas.toBlob((blob)=>{
          const dl = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = dl; a.download = "jp-plate.png";
          document.body.appendChild(a); a.click();
          a.remove(); URL.revokeObjectURL(dl);
        }, "image/png");
      };
      img.src = url;
    }

    function randOf(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    const offices = ["品川","足立","横浜","多摩","名古屋","大阪","京都","神戸","福岡","札幌","大宮","練馬","所沢","川越","成田"];
    const kanaPrivate = [..."さすせそたちつてとなにぬねのはひふほまみむめもやゆよらりるろわ"];
    const kanaCommercial = [..."あいうえかきくけこを"];
    function randomize(){
      plateType.value = randOf(["private","commercial","kei_private","kei_commercial"]);
      office.value = randOf(offices);
      classCode.value = randOf(["300","330","500","530","700","800"]);
      kana.value = (plateType.value==="commercial"||plateType.value==="kei_commercial") ? randOf(kanaCommercial) : randOf(kanaPrivate);
      serial.value = Math.floor(Math.random()*10000).toString().padStart(4,"0");
      smallSuffix.value = Math.random()<0.25 ? randOf("ACFHKLMPXY".split("")) : "";
      update();
    }

    [office,classCode,kana,serial,plateType,smallSuffix].forEach(el=>{
      el.addEventListener("input", update);
      el.addEventListener("change", update);
    });
    document.getElementById("randomBtn").addEventListener("click",(e)=>{ e.preventDefault(); randomize(); });
    document.getElementById("policeNormalBtn").addEventListener("click",(e)=>{ e.preventDefault(); applyPolicePreset({ type:"normal" }); });
    document.getElementById("policeKeiBtn").addEventListener("click",(e)=>{ e.preventDefault(); applyPolicePreset({ type:"kei" }); });
    document.getElementById("downloadSvgBtn").addEventListener("click",(e)=>{ e.preventDefault(); downloadSVG(); });
    document.getElementById("downloadPngBtn").addEventListener("click",(e)=>{ e.preventDefault(); downloadPNG(); });

    update();
  </script>
</body>
</html>
