<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ChatGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font Awesome 5.15.4 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    :root{
      --bg:#1e1e1e; 
      --panel:#ffffff; 
      --border:#e5e5e5; 
      --muted:#6b7280; 
      --text:#111827;
      --accent:#10a37f;
      --accent-pressed:#0e8f6f; 
      --user:#171717;
      --assistant:#ffffff;
      --code-bg:#0b1020; 
      --code-fg:#e5e7eb; 
      --chip:#efefef;
      --shadow:0 1px 2px rgba(0,0,0,.04),0 8px 40px rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      :root{
      --bg:#0f1216; 
      --panel:#14171c; 
      --border:#272a31; 
      --muted:#9aa3af;
      --text:#e5e7eb;
      --assistant:#1b1f26; 
      --chip:#20242b; 
      --shadow:none;
      }
    }
    *{box-sizing:border-box}
    body{
      font-family: ui-sans-serif, "Helvetica Neue", Helvetica, Arial, "Noto Sans TC", "PingFang TC", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg); 
      color: var(--text); 
      margin:0; height:100vh; 
      display:flex; 
      justify-content:center; 
      align-items:stretch;
    }
    .app{ 
      width:min(960px, 100%); 
      height:100vh; display:flex; 
      flex-direction:column; }
    .topbar{
      height:56px; 
      display:flex; 
      align-items:center; 
      gap:8px; 
      padding:0 16px;
      background:var(--panel); 
      border-bottom:1px solid var(--border); 
      position:sticky; 
      top:0; 
      z-index:10;
    }
    .logo{ 
      display:flex; 
      align-items:center; 
      gap:20px; 
      font-weight:700; 
    }
    .dot{ 
      width:22px; 
      height:22px; 
      display:inline-grid; 
      place-items:center; 
      color:#fff; 
      font-size:20px; 
      font-weight:500; 
      letter-spacing:0.3px;
    }
    .spacer{
      flex:1
    }
    .ghost{ 
      background:transparent; 
      border:1px solid var(--border); 
      color:var(--text); 
      padding:8px 10px; 
      border-radius:8px; 
      cursor:pointer; 
    }
    .ghost:hover{
      background:rgba(0,0,0,.03)
    }

    /* Chat area */
    .chat{ 
      flex:1; 
      overflow-y:auto; 
      padding:24px 12px 16px; 
      scroll-behavior:smooth; 
    }
    .row{ 
      display:flex; 
      padding:14px 12px; 
      border-radius:12px; 
      transition:background .2s ease; 
      position:relative; 
    }
    .row.user{ 
      justify-content:flex-end; 
    }
    .row.assistant{ 
      justify-content:flex-start; 
    }

    /* ===== åªæœ‰useræœ‰æ³¡æ³¡ ===== */
    .bubble{
      max-width:min(78ch, calc(100vw - 100px));
      border:1px solid var(--border); 
      box-shadow: var(--shadow);
      border-radius:12px; 
      padding:12px 14px; 
      line-height:1.6; 
      font-size:15px; 
      white-space:pre-wrap; 
      word-wrap:break-word; 
      background:var(--assistant);
    }
    .row.user .bubble{
      background:var(--user); 
      color:#fff; 
      border-color:transparent;
    }
    /* æ‰å¹³AIè¨­è¨ˆ */
    .row.assistant .bubble{
      background:transparent; 
      border:none; 
      box-shadow:none; 
      padding:0;
      max-width:min(88ch, calc(100vw - 120px));
    }

    /* Meta è¡Œç‚º */
    .meta{ 
      display:none !important; 
    }
    .row.assistant .meta{ 
      text-align:left; 
    }

    /* typing indicator */
    .typing{ 
      display:inline-flex; 
      gap:6px; 
    }
    .typing span{ 
      width:6px; 
      height:6px; 
      background: currentColor; 
      opacity:.35; 
      border-radius:50%; a
      nimation: blink 1.2s infinite both; 
    }
    .typing span:nth-child(2){ 
      animation-delay:.15s 
    } 
    .typing span:nth-child(3){ 
      animation-delay:.3s 
    }
    @keyframes blink { 0%,80%,100%{opacity:.2} 40%{opacity:1} }
    
    [hidden]{ 
      display:none !important; 
    }

    /* code block */
    pre{
      background: var(--code-bg); 
      color: var(--code-fg);
      border-radius:10px; 
      padding:14px; 
      overflow:auto; 
      border:1px solid #1f2937;
      line-height:1.5; 
      font-size:13px; 
      margin:10px 0;
      position:relative;
    }
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .copy-btn{
      position:absolute; 
      top:8px; right:8px; 
      font-size:12px; 
      border:1px solid #374151;
      background:#0f172a; 
      color:#e5e7eb; 
      padding:6px 8px; 
      border-radius:8px; 
      cursor:pointer;
    }
    .copy-btn.copied{ 
      background:#0b7b62; 
      border-color:#0b7b62; 
    }

    /* Actionsï¼šassistant æ”¾åœ¨å¡Šå³ä¸Šï¼›user æ”¾åœ¨æ³¡æ³¡ä¸‹ç·£ */
    .actions{
      position:absolute; 
      display:flex; 
      gap:8px; 
      opacity:0; 
      transition:opacity .15s ease;
    }
    .row:hover .actions{ 
     opacity:1; 
    }
    .row.user .actions{
     right:8px;
     bottom:-10px;
    }
    .row.assistant .actions{ 
     left:8px; 
     top:auto;
     bottom:-10px; 
    }
    .act{
      font-size:12px; 
      border:1px solid var(--border); 
      background:var(--panel); 
      color:var(--text);
      padding:6px 8px; 
      border-radius:8px; 
      cursor:pointeråœæ­¢æŒ‰éµ; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center;
    }
    .act i{ 
      font-size:14px; 
      pointer-events:none; 
    }

    /* suggestions chips */
    .chips{ 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      padding:6px 12px 16px; 
    }
    .chip{ 
      border:1px solid var(--border); 
      background:var(--chip); 
      color:var(--text); 
      padding:8px 10px; 
      border-radius:999px; 
      font-size:13px; cursor:pointer; 
    }

    /* Input area */
    .composer{ 
      padding:10px 12px 16px; 
      background:var(--panel); 
      border-top:1px solid var(--border); 
      position:sticky; 
      bottom:0; 
      z-index:5; }
    .bar{ 
      display:flex; 
      gap:8px; 
      align-items:flex-end; 
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:8px; 
      background:var(--panel); 
    }
    textarea{ 
      flex:1; 
      resize:none; 
      border:none; 
      outline:none; 
      background:transparent; 
      color:var(--text); 
      max-height:180px; 
      min-height:24px; font-size:15px; 
      line-height:1.5; 
    }
    .btn{ 
      background:var(--accent); 
      color:#fff; border:none; 
      padding:10px 14px; 
      border-radius:36px; 
      font-weight:600; 
      cursor:pointer; 
    }
    .btn:disabled{ 
      opacity:.5; 
      cursor:not-allowed
    }
    .btn.secondary{ 
      background:transparent; c
      olor:var(--text); 
      border:1px solid var(--border); 
    }
    .hint{ 
      margin-top:8px; 
      font-size:12px; 
      color:var(--muted); 
      text-align:center; 
    }

    /* é€å‡ºæŒ‰éµ */
    #sendBtn { 
      width:40px; 
      height:40px; 
      padding:0; 
      display:inline-grid; 
      place-items:center; 
      border-radius:999px; 
    }
    
    #sendBtn i{ 
      font-size:16px; 
      line-height:1; 
      pointer-events:none; 
    }
    #sendBtn:disabled i{ opacity:.8; }
    
    /* åœæ­¢æŒ‰éµ */
    #stopBtn{
      width:40px;
      height:40px;
      padding:0;
      display:inline-grid;     
      place-items:center;
      border-radius:999px;
    }
    #stopBtn i{
      font-size:16px;          
      line-height:1;
      pointer-events:none;
   }


    /* Rich content styles */
    .bubble h1,.bubble h2,.bubble h3{ 
      margin:.4em 0 .2em; line-height:1.3 
    }
    .bubble h1{ 
      font-size:22px 
    } .bubble h2{ 
      font-size:20px 
    } .bubble h3{ 
      font-size:18px 
    }
    .bubble hr{ 
      border:0; 
      border-top:1px solid var(--border); 
      margin:12px 0 
    }
    .bubble blockquote{ 
      margin:8px 0; 
      padding:8px 12px; 
      border-left:3px solid var(--border); 
      background: rgba(0,0,0,.03) 
    }
    @media (prefers-color-scheme: dark){ .bubble blockquote{ background: rgba(255,255,255,.03) } }
    .bubble img{ 
      max-width:100%; 
      height:auto; 
      border-radius:8px; 
      border:1px solid var(--border) }
    .callout{ 
      border:1px solid var(--border); 
      border-radius:10px; 
      padding:10px 12px; 
      margin:10px 0; 
      display:flex; 
      gap:10px; 
      align-items:flex-start; 
    }
    .callout .ico{ 
      flex:0 0 18px; 
      line-height:1 
    }
    .callout.info{ 
      background:#eef6ff 
    } 
    .callout.warn{ 
      background:#fff8e6 
    } .callout.success{ 
      background:#eefaf5 
    }
    @media (prefers-color-scheme: dark){ .callout.info{ background:#0f1a26 } .callout.warn{ background:#251e0b } .callout.success{ background:#0d1a15 } }
    .bubble table{ 
      width:100%; border-collapse:collapse; 
      margin:10px 0; 
      font-size:14px 
    }
    .bubble table th,.bubble table td{ 
      border:1px solid var(--border); 
      padding:8px; text-align:left 
    }
    .bubble table th{ 
      background:rgba(0,0,0,.04) 
    }
    @media (prefers-color-scheme: dark){ .bubble table th{ background:rgba(255,255,255,.05) } }
    .task{ display:flex; 
      gap:8px; 
      align-items:center; 
      margin:4px 0 
    } 
    .task input{ accent-color: var(--accent) }
  </style>
  
  
</head>
<body>
  <div class="app">
    <div class="topbar">
    <div class="logo">
      <div class="dot">ChatAny</div>
    </div>
      <div class="spacer"></div>
      <button class="ghost" id="clearBtn" title="æ¸…é™¤æœƒè©±" aria-label="æ¸…é™¤">
       <i class="fas fa-trash" aria-hidden="true"></i>
      </button>
    </div>

    <div id="chat" class="chat" aria-live="polite" aria-label="èŠå¤©è¨Šæ¯"></div>
    <div class="chips" id="chips"></div>

    <div class="composer">
      <form id="composerForm" class="bar">
        <textarea id="input" placeholder="è©¢å•ä»»ä½•å•é¡Œ"></textarea>
        <button type="button" class="btn secondary" id="stopBtn" hidden title="åœæ­¢ç”¢ç”Ÿ">
          <i class="fas fa-stop" aria-hidden="true"></i><span class="sr-only">åœæ­¢</span>
        </button>
        <button type="submit" class="btn" id="sendBtn" disabled aria-label="é€å‡º" title="é€å‡º (Enter)">
          <i class="fas fa-arrow-up"></i>
        </button>
      </form>
      <div class="hint"> ChatAny å¯èƒ½æœƒå‡ºéŒ¯ï¼Œè«‹æŸ¥æ ¸é‡è¦è³‡è¨Šã€‚</div>
    </div>
  </div>

  <script>
  (function(){
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else { boot(); }

    function boot(){
      const $  = (sel, el=document) => el.querySelector(sel);
      const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

      const chat     = $('#chat');
      const input    = $('#input');
      const sendBtn  = $('#sendBtn');
      const stopBtn  = $('#stopBtn');
      const clearBtn = $('#clearBtn');
      const chipsWrap= $('#chips');

      if(!chat || !input || !sendBtn){ console.error('å¿…è¦ç¯€é»ç¼ºå¤±'); return; }

      /* localStorage å®‰å…¨å°è£ */
      const safeStore = (()=> {
        try{
          const k='__test__'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k);
          return {
            get: (key, fallback='[]') => JSON.parse(localStorage.getItem(key) || fallback),
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            clear: key => localStorage.removeItem(key)
          };
        }catch(e){
          const mem = new Map();
          return {
            get: (key, fallback='[]') => mem.has(key) ? mem.get(key) : JSON.parse(fallback),
            set: (key, val) => mem.set(key, val),
            clear: key => mem.delete(key)
          };
        }
      })();

      const STORAGE_KEY = 'demo-chat';

      const demoReplies = [
      `# å—¨ï¼ä»Šå¤©æƒ³åšä»€éº¼ï¼Ÿ
      é€™è£¡æœ‰å¹¾å€‹ä½ å¯ä»¥è©¦è©¦çœ‹çš„æƒ³æ³•ï¼š
      - ç”Ÿæˆä¸€ä»½ç°¡å ±å¤§ç¶±
      - ç”¨æ¢åˆ—å¼æ‘˜è¦ä¸€ç¯‡æ–‡ç« 
      - å¯«ä¸€æ®µå¯ç›´æ¥åŸ·è¡Œçš„å°å·¥å…·
      > ä¹Ÿå¯ä»¥è²¼ä¸Šå…§å®¹ï¼Œæˆ‘æœƒè‡ªå‹•å¹«ä½ æ•´ç†æˆé‡é»ã€‚`,

      `## æˆ‘æœƒæ€éº¼è™•ç†ä½ çš„ä»»å‹™
      1.é‡æ¸…ç›®æ¨™èˆ‡è¼¸å‡ºæ ¼å¼
      2.ç”Ÿæˆåˆç¨¿ï¼ˆå«å¯è¡Œæ›¿ä»£ï¼‰
      3.ç”¢ç”Ÿé©—æ”¶æ¸…å–®èˆ‡å¾ŒçºŒå‹•ä½œ
      ---
      ä½ å¯ä»¥èªªï¼šã€Œå¹«æˆ‘åšå€‹ 7 å¤©å­¸ç¿’è¨ˆç•«ï¼ˆå«æ¯å¤© 30 åˆ†é˜ï¼‰ã€`,

      `é€™æ˜¯ä¸€å€‹ç°¡å–®çš„ç¯€æµå‡½æ•¸ï¼ˆthrottleï¼‰ç¯„ä¾‹ï¼Œé¿å…äº‹ä»¶è¢«éåº¦è§¸ç™¼ï¼š
       \`\`\`js
       function throttle(fn, wait=200){
       let last = 0, timer;
       return (...args)=>{
       const now = Date.now();
       if(now - last > wait){
       last = now; fn(...args);
       }else{
       clearTimeout(timer);
       timer = setTimeout(()=>{ last = Date.now(); fn(...args); }, wait - (now - last));
         }
        };
       }
       \`\`\`
       **ç”¨æ³•**ï¼šåœ¨ scroll/resize ç›£è½å™¨è£¡åŒ…ä¸€å±¤å³å¯ã€‚`,

       `<div class="callout info"><div class="ico">ğŸ’¡</div><div>å°æŠ€å·§ï¼šå…ˆæè¿° <b>èƒŒæ™¯</b>ã€<b>è¼¸å‡ºæ ¼å¼</b>ã€<b>é™åˆ¶</b>ï¼Œå“è³ªæœƒæ›´ç©©å®šã€‚</div></div>
       <div class="task"><input type="checkbox" disabled> å…ˆæä¾›ä½¿ç”¨æƒ…å¢ƒï¼ˆèª°æœƒè®€ï¼Ÿï¼‰</div>
       <div class="task"><input type="checkbox" disabled> æŒ‡å®šè¼¸å‡ºæ ¼å¼ï¼ˆä¾‹å¦‚ï¼šJSON / è¡¨æ ¼ / æ¢åˆ—ï¼‰</div>
       <div class="task"><input type="checkbox" disabled> åˆ—å‡ºç¡¬æ€§é™åˆ¶ï¼ˆå­—æ•¸ã€èªæ°£ã€å«ä¸å«ç¨‹å¼ç¢¼ï¼‰</div>`,

       `<h3>å…©å€‹æ–¹æ¡ˆæ¯”è¼ƒ</h3>
       <table>
       <thead><tr><th>æ–¹æ¡ˆ</th><th>å„ªé»</th><th>é¢¨éšª</th></tr></thead>
       <tbody>
       <tr><td>Aï¼šå¿«é€Ÿä¸Šç·š</td><td>æ™‚ç¨‹çŸ­ã€å½±éŸ¿å°</td><td>æŠ€è¡“å‚µå¯èƒ½ç´¯ç©</td></tr>
       <tr><td>Bï¼šé‡æ§‹å¾Œæ¨å‡º</td><td>é•·æœŸç¶­è­·æˆæœ¬ä½</td><td>åˆæœŸæŠ•å…¥è¼ƒé«˜</td></tr>
       </tbody>
       </table>
       å»ºè­°ï¼šå…ˆ A é©—è­‰å¸‚å ´ï¼Œå†ä»¥ B æ¼¸é€²é‡æ§‹ã€‚`,

       `<details>
       <summary><b>å¸¸è¦‹å•é¡Œï¼šæˆ‘è©²éœ€è¦ä¼‘æ¯å¤šä¹…ï¼Ÿ</b></summary>
       <div style="margin-top:8px">ä¸€å¥è©±ç‰ˆæœ¬ + è¦æ±‚è¼¸å‡ºæ ¼å¼å°±å¤ èµ·æ­¥ï¼›è‹¥æ˜¯é•·ä»»å‹™ï¼ŒåŠ ä¸Šç¯„ä¾‹è¼¸å‡ºæ›´å¥½ã€‚</div>
       </details>`,

       `é€™æ˜¯ä½ˆå±€éˆæ„Ÿåœ–ï¼ˆåƒ…ç¤ºæ„ï¼‰ï¼š
       ![Layout idea](https://picsum.photos/seed/chat-ui/800/400)
       ä½ å¯ä»¥å‘Šè¨´æˆ‘æƒ³ä¿ç•™å“ªäº›å…ƒç´ ï¼Œæˆ‘ç›´æ¥è¼¸å‡º HTML/CSS ç¯„æœ¬ã€‚`,

       `éœ€è¦æ›´æŠ€è¡“å‘çš„å›è¦†ï¼ŸåŠ ä¸Šã€Œè«‹ä»¥å·¥ç¨‹æ‰‹å†Šèªæ°£ã€ã€‚
       [åƒè€ƒå¯«ä½œèªæ°£æŒ‡å¼•](https://www.nngroup.com/articles/tone-of-voice-dimensions/)

        > æº–å‚™å¥½äº†å°±æŠŠä½ çš„ç´ æè²¼ä¸Šä¾†å§ï¼Œæˆ‘æœƒå…ˆå¹«ä½ åšä¸€æ¬¡ã€Œçµæ§‹åŒ–æ‹†è§£ã€ã€‚`
      ];

      const demoChips = [
        "å¹«æˆ‘æŠŠé€™æ®µæ”¹æˆæ¢åˆ—é‡é»",
        "å¯«å­¸ç¿’è¨ˆç•«",
        "å¹«æˆ‘æŠŠ API æ–‡ä»¶æ•´ç†æˆè¡¨æ ¼",
        "ç”¨å·¥ç¨‹æ‰‹å†Šèªæ°£ï¼Œå¯«å‡ºéƒ¨ç½²æ­¥é©Ÿ",
        "æŠŠä¸‹é¢ JS é‡æ§‹ä¸¦åŠ è¨»è§£",
        "ç”¢ç”Ÿä¸€ä»½ PR æ¨¡æ¿ï¼ˆå«æª¢æŸ¥æ¸…å–®ï¼‰"
      ];

      let streaming = null;
      let store = safeStore.get(STORAGE_KEY, '[]');
      
      /* åªæ”¹é€™å€‹å‡½å¼ï¼šæŒ‰éµé¡¯ç¤ºç‹€æ…‹ */
      function setStreamingUI(on){
        if (on) {
          // ç™¼é€ä¸­ï¼šéš±è—é€å‡ºã€é¡¯ç¤ºåœæ­¢
          sendBtn.hidden = true;
          sendBtn.style.display = 'none';

          stopBtn.hidden = false;
          stopBtn.style.display = 'inline-grid';
          stopBtn.disabled = false;
        } else {
          // ç™¼é€ä¸­ï¼šé¡¯ç¤ºé€å‡ºï¼ˆä¾æ˜¯å¦æœ‰å­—æ±ºå®šç¦ç”¨ï¼‰ã€éš±è—åœæ­¢
          const hasText = (input.value || '').trim().length > 0;

          sendBtn.hidden = false;
          sendBtn.style.display = 'inline-grid';
          sendBtn.disabled = !hasText;

          stopBtn.hidden = true;
          stopBtn.style.display = 'none';
          stopBtn.disabled = true;
        }

        // ç·¨è¼¯å€é«”é©—èˆ‡ç„¡éšœç¤™
        input.readOnly = on;
        input.setAttribute('aria-busy', on ? 'true' : 'false');
        if(!on){ input.focus(); }
      }

      /* Markdown-lite */
      function renderMarkdown(text){
        let html = String(text || '');

        const fenceRegex = /```(\w+)?\n([\s\S]*?)```/g;
        html = html.replace(fenceRegex, (m, lang='', code='')=>{
          const safe = code.replace(/[&<>]/g, s=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;' }[s]));
          return `<pre data-lang="${lang || ''}"><button class="copy-btn" title="è¤‡è£½ä»£ç¢¼">è¤‡è£½</button><code>${safe}</code></pre>`;
        });

        // åœ–ç‰‡
        html = html.replace(/!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)/g, '<img alt="$1" src="$2" />');

        // é€£çµ
        html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');

        // è¡Œå…§ code
        html = html.replace(/`([^`]+)`/g, (_, c)=>{
          const safe = c.replace(/[&<>]/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[s]));
          return `<code>${safe}</code>`;
        });

        // æ¨™é¡Œ
        html = html.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
                   .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
                   .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

        // å¼•è¨€
        html = html.replace(/^>\s?(.*)$/gm, '<blockquote>$1</blockquote>');

        // æ°´å¹³ç·š
        html = html.replace(/^\s*---\s*$/gm, '<hr/>');

        // ä»»å‹™æ¸…å–®
        html = html.replace(/^- \[( |x|X)\] (.*)$/gm, (m, chk, txt)=>{
          const checked = /x/i.test(chk) ? 'checked' : '';
          return `<div class="task"><input type="checkbox" ${checked} disabled> ${txt}</div>`;
        });

        // ç²—é«” / æ–œé«”
        html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                   .replace(/\*([^*]+)\*/g, '<em>$1</em>');

        // æ›è¡Œ
        html = html.replace(/\n/g, '<br/>');

        return html;
      }

      function row(role, content){
        const r = document.createElement('div');
        r.className = `row ${role}`;

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = content;

        const wrap = document.createElement('div');
        wrap.style.display = 'flex';
        wrap.style.flexDirection = 'column';
        wrap.appendChild(bubble);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        wrap.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'actions';

        // è¤‡è£½
        const copyBtn = document.createElement('button');
        copyBtn.className = 'act';
        copyBtn.innerHTML = '<i class="fas fa-copy" aria-hidden="true"></i>';
        copyBtn.title = 'è¤‡è£½';
        copyBtn.setAttribute('aria-label', 'è¤‡è£½');
        copyBtn.onclick = ()=> {
          copyText(stripHtml(bubble.innerHTML));
          const prev = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check"></i>';
          setTimeout(()=> copyBtn.innerHTML = prev, 900);
        };
        actions.append(copyBtn);

        // åªæœ‰AIè¨Šæ¯é¡¯ç¤ºé‡æ–°ç”¢ç”Ÿ
        if (r.classList.contains('assistant')) {
          const regenBtn = document.createElement('button');
          regenBtn.className = 'act';
          regenBtn.innerHTML = '<i class="fas fa-sync-alt" aria-hidden="true"></i>';
          regenBtn.title = 'é‡æ–°ç”¢ç”Ÿ';
          regenBtn.setAttribute('aria-label', 'é‡æ–°ç”¢ç”Ÿ');
          regenBtn.onclick = ()=> regenerate(r);
          actions.append(regenBtn);
        }

        r.append(wrap, actions);

        // äº‹ä»¶ä»£ç†ï¼šcode block copy
        r.addEventListener('click', e=>{
          const target = e.target;
          if(target && target.classList && target.classList.contains('copy-btn')){
            const codeEl = target.parentElement && target.parentElement.querySelector('code');
            const code = codeEl ? codeEl.innerText : '';
            navigator.clipboard.writeText(code).then(()=>{
              target.textContent = 'å·²è¤‡è£½';
              target.classList.add('copied');
              setTimeout(()=>{ target.textContent='è¤‡è£½'; target.classList.remove('copied'); }, 1200);
            });
          }
        });

        return r;
      }

      function stripHtml(html){
        const tmp = document.createElement('div');
        tmp.innerHTML = html || '';
        return tmp.textContent || tmp.innerText || '';
      }

      function rafScrollToBottom(){ requestAnimationFrame(()=>{ chat.scrollTop = chat.scrollHeight; }); }

      function appendTyping(){
        const typing = row('assistant', `<div class="typing"><span></span><span></span><span></span></div>`);
        chat.appendChild(typing);
        rafScrollToBottom();
        return typing;
      }

      function streamInto(el, fullText, {interval=18}={}){
        if(!el) return;
        let i = 0;
        setStreamingUI(true);
        
        el.innerHTML = '';
        clearInterval(streaming);
        streaming = setInterval(()=>{
          i += 2;
          el.innerHTML = renderMarkdown(fullText.slice(0, i));
          chat.scrollTop = chat.scrollHeight;
          if(i >= fullText.length){
            clearInterval(streaming);
            streaming = null;
            setStreamingUI(false);
            persist();
          }
        }, interval);
      }

      function stopStream(){
        if(streaming){
          clearInterval(streaming);
          streaming = null;
        }
        setStreamingUI(false);
      }

      function sendMessage(text){
        setStreamingUI(true);
        const userRow = row('user', renderMarkdown(text));
        chat.appendChild(userRow);
        rafScrollToBottom();

        const typingRow = appendTyping();

        setTimeout(()=>{
          const reply = demoReplies[Math.floor(Math.random()*demoReplies.length)];
          const assistantRow = row('assistant', '');
          chat.replaceChild(assistantRow, typingRow);
          const bubble = assistantRow.querySelector('.bubble');
          streamInto(bubble, reply);
          persist();
        }, 200);
      }

      function regenerate(targetRow){
        const next = targetRow && targetRow.nextElementSibling;
        const reply = demoReplies[Math.floor(Math.random()*demoReplies.length)];
        const newRow = row('assistant', '');
        if(next) chat.insertBefore(newRow, next); else chat.appendChild(newRow);
        setStreamingUI(true);
        streamInto(newRow.querySelector('.bubble'), reply);
        persist();
      }

      function persist(){
        try{
          const data = [];
          $$('.row').forEach(r=>{
            const role = r.classList.contains('user') ? 'user' : 'assistant';
            const text = stripHtml(r.querySelector('.bubble')?.innerHTML || '');
            data.push({role, text});
          });
          safeStore.set(STORAGE_KEY, data);
        }catch(e){ /* ignore */ }
      }

      function restore(){
        chat.innerHTML='';
        let store;
        try{ store = safeStore.get(STORAGE_KEY, '[]'); }catch(e){ store = []; }

         if(!store || !store.length){
         const welcomes = [
         "Fuck ğŸ¤¦â€â™‚ï¸â€¦ ä½ çœŸçš„ä¾†äº†ï¼Ÿæ­¡è¿ä¾†åˆ°é€™å€‹å¥‡æ€ªçš„èŠå¤©å®¤ ğŸ‰\n\n*(å°å¿ƒï¼Œé€™è£¡çš„ç­”æ¡ˆå¯èƒ½æ¯”ä½ æœ‹å‹é‚„ä¸å¯é )*",
         "å¹¹ä½ å¨˜ï¼Œå±…ç„¶çœŸçš„æœ‰äººè·‘é€²ä¾† ğŸ¤£ æ­¡è¿ä¾†åˆ°é€™å€‹åƒåœ¾èŠå¤©å®¤ ğŸ—‘ï¸",
         "ç«Ÿç„¶é‚„æœ‰äººç”¨é€™èŠå¤©å®¤ ğŸ˜‚\nå¥½å•¦ï¼Œåä¸‹ä¾†éš¨ä¾¿å•å§ã€‚",
         "ä½ é»é–‹çš„ä¸æ˜¯æ¯’è˜‹æœï¼Œè€Œæ˜¯è¶…å»¢èŠå¤©å®¤ ğŸ\nï¼ˆè¨˜å¾—éš¨æ™‚ ctrl+c / command+cï¼‰",
         "yeah ğŸ¸ æ­¡è¿ä¾†åˆ° AI å»¢è©±ä¸­å¿ƒâ„¢\né€™è£¡çš„å›ç­”å“è³ª = å¿ƒæƒ…æŒ‡æ•¸ Â± 87%",
         "ğŸ’ï¼åˆ¥æ‡·ç–‘ï¼Œé€™è£¡æ‰¾ä¸åˆ°æ¨™æº–ç­”æ¡ˆçš„åœ°æ–¹"
         ];

       const pick = welcomes[Math.floor(Math.random() * welcomes.length)];
       const hi = row('assistant', renderMarkdown(pick));
       chat.appendChild(hi);
        }

        else{
          for(const m of store){
            const r = row(m.role, renderMarkdown(m.text || ''));
            chat.appendChild(r);
          }
        }
        rafScrollToBottom();
      }

      function initChips(){
        if(!chipsWrap) return;
        chipsWrap.innerHTML='';
        const demoChips = [
          "æŠŠæ–‡ä»¶æ”¹æˆæ¢åˆ—",
          "å¯«å­¸ç¿’è¨ˆç•«",
          "æŠŠæ–‡ä»¶æ•´ç†æˆè¡¨æ ¼",
          "å¯«å‡ºéƒ¨ç½²æ­¥é©Ÿ",
          "æŠŠJSé‡æ§‹ä¸¦åŠ è¨»è§£",
          "ç”¢ç”ŸPRæ¨¡æ¿"
        ];
        demoChips.forEach(t=>{
          const c = document.createElement('button');
          c.type='button'; c.className='chip'; c.textContent=t;
          c.onclick = ()=> {
            input.value = t;
            resizeInput();
            sendBtn.disabled = !input.value.trim();
            if(!sendBtn.disabled) form?.requestSubmit();
          };
          chipsWrap.appendChild(c);
        });
      }

      function copyText(text){ navigator.clipboard?.writeText(String(text || '')); }

      const form = $('#composerForm');
      if(form){
        form.addEventListener('submit', e=>{
          e.preventDefault();
          const text = (input.value || '').trim();
          if(!text) return;
          sendMessage(text);
          input.value=''; resizeInput(); sendBtn.disabled = true;
        });
      }

      input.addEventListener('input', ()=>{
        resizeInput();
        sendBtn.disabled = !input.value.trim();
      });
      input.addEventListener('keydown', (e)=>{
        if ((e.key === 'Enter' && (e.metaKey || e.ctrlKey))) { // Cmd/Ctrl + Enter
          e.preventDefault();
          if(!sendBtn.disabled) form?.requestSubmit();
          return;
        }
        if(e.key === 'Enter' && !e.shiftKey){ // Enter = é€å‡º
          e.preventDefault();
          if(!sendBtn.disabled) form?.requestSubmit();
        }
      });

      stopBtn?.addEventListener('click', stopStream);

      clearBtn?.addEventListener('click', ()=>{
        if(confirm('ç¢ºå®šè¦æ¸…é™¤å—ï¼Ÿ')){
          safeStore.clear(STORAGE_KEY);
          restore();
        }
      });

      function resizeInput(){
        input.style.height = '24px';
        input.style.height = Math.min(input.scrollHeight, 180) + 'px';
      }

      restore();
      initChips();
      setStreamingUI(false);
    }
  })();
  </script>
</body>
</html>
